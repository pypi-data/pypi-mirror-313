"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[320],{1320:(e,t,r)=>{r.r(t),r.d(t,{default:()=>M});var i=r(8672),s=r(700),o=r(9232),n=r(2626),a=r(3105),l=r(3476),h=r(5292),c=r(7262),d=r(2963),m=r(4583);class u{constructor(e){this._currentData=null,this._mistralProvider=new d.MistralAI({...e.settings}),this._throttler=new m.Throttler((async e=>{var t;const r=e,i=this._mistralProvider.completionWithRetry(e,{},!1),s=new Promise((e=>setTimeout((()=>e(null)),3e3))),o=await Promise.race([i,s]);return null===o||r.prompt!==(null===(t=this._currentData)||void 0===t?void 0:t.prompt)?{items:[],fetchAgain:!0}:{items:o.choices.map((e=>({insertText:e.message.content})))}}),{limit:1e3})}get provider(){return this._mistralProvider}set requestCompletion(e){this._requestCompletion=e}async fetch(e,t){const{text:r,offset:i}=e,s={prompt:r.slice(0,i),suffix:r.slice(i),model:this._mistralProvider.model,stream:!1,stop:[]};try{this._currentData=s;const e=await this._throttler.invoke(s);return e.fetchAgain&&this._requestCompletion&&this._requestCompletion(),{items:e.items}}catch(e){return console.error("Error fetching completions",e),{items:[]}}}}class p extends i.ChatModel{constructor(e){super(e),this._errorMessage="",this._history={messages:[]},this._defaultErrorMessage="AI provider not configured",this._aiProvider=e.aiProvider,this._aiProvider.modelChange.connect((()=>{this._errorMessage=this._aiProvider.chatError}))}get provider(){return this._aiProvider.chatModel}async sendMessage(e){e.id=c.UUID.uuid4();const t={id:e.id,body:e.body,sender:{username:"User"},time:Date.now(),type:"msg"};if(this.messageAdded(t),null===this._aiProvider.chatModel){const e={id:c.UUID.uuid4(),body:`**${this._errorMessage?this._errorMessage:this._defaultErrorMessage}**`,sender:{username:"ERROR"},time:Date.now(),type:"msg"};return this.messageAdded(e),!1}this._history.messages.push(t);const r=(0,h.eu)(this._history.messages.map((e=>"User"===e.sender.username?new h.xc(e.body):new h.Od(e.body))));return this.updateWriters([{username:"AI"}]),this._aiProvider.chatModel.invoke(r).then((e=>{const t=e.content,r={id:c.UUID.uuid4(),body:t.toString(),sender:{username:"AI"},time:Date.now(),type:"msg"};return this.messageAdded(r),this._history.messages.push(r),!0})).catch((e=>{const t=function(e,t){return"MistralAI"===e?t.message:"Unknown provider"}(this._aiProvider.name,e),r={id:c.UUID.uuid4(),body:`**${t}**`,sender:{username:"ERROR"},time:Date.now(),type:"msg"};return this.messageAdded(r),!1})).finally((()=>{this.updateWriters([])}))}async getHistory(){return this._history}dispose(){super.dispose()}messageAdded(e){super.messageAdded(e)}}var g=r(4602);class _{constructor(e){this.identifier="@jupyterlite/ai",this._name="None",this._completer=null;const{name:t,settings:r}=e;this._requestCompletion=e.requestCompletion,this.setCompleter(t,r)}setCompleter(e,t){try{this._completer=function(e,t){return"MistralAI"===e?new u({settings:t}):null}(e,t),this._completer&&(this._completer.requestCompletion=this._requestCompletion),this._name=null===this._completer?"None":e}catch(e){throw this._completer=null,this._name="None",e}}get name(){return this._name}get completer(){return this._completer}get llmCompleter(){var e;return(null===(e=this._completer)||void 0===e?void 0:e.provider)||null}async fetch(e,t){var r;return null===(r=this._completer)||void 0===r?void 0:r.fetch(e,t)}}class v{constructor(e){this._llmChatModel=null,this._name="None",this._modelChange=new g.Signal(this),this._chatError="",this._completerError="",this._completionProvider=new _({name:"None",settings:{},requestCompletion:e.requestCompletion}),e.completionProviderManager.registerInlineProvider(this._completionProvider)}get name(){return this._name}get completer(){return null===this._name?null:this._completionProvider.completer}get chatModel(){return null===this._name?null:this._llmChatModel}get chatError(){return this._chatError}get completerError(){return this._completerError}setModels(e,t){try{this._completionProvider.setCompleter(e,t),this._completerError=""}catch(e){this._completerError=e.message}try{this._llmChatModel=function(e,t){return"MistralAI"===e?new d.ChatMistralAI({...t}):null}(e,t),this._chatError=""}catch(e){this._chatError=e.message,this._llmChatModel=null}this._name=e,this._modelChange.emit()}get modelChange(){return this._modelChange}}!function(e){function t(e,t){const r=Object.getOwnPropertyDescriptor(e,t)||Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),t)||{};return Boolean(r.writable)}e.isWritable=t,e.updateConfig=function(e,r){Object.entries(r).forEach((([r,i],s)=>{if(r in e){const s=r;t(e,s)&&(e[s]=i)}}))}}(v||(v={}));const y=new c.Token("@jupyterlite/ai:AIProvider","Provider for chat and completion LLM provider"),C={id:"@jupyterlite/ai:chat",description:"LLM chat extension",autoStart:!0,optional:[n.INotebookTracker,l.ISettingRegistry,s.IThemeManager],requires:[y,a.IRenderMimeRegistry],activate:async(e,t,r,s,o,n)=>{let a=null;s&&(a=new i.ActiveCellManager({tracker:s,shell:e.shell}));const l=new p({aiProvider:t,activeCellManager:a});let h=!1,c=!0;function d(e){h=e.get("sendWithShiftEnter").composite,c=e.get("enableCodeToolbar").composite,l.config={sendWithShiftEnter:h,enableCodeToolbar:c}}Promise.all([e.restored,null==o?void 0:o.load(C.id)]).then((([,e])=>{e?(d(e),e.changed.connect(d)):console.warn("The SettingsRegistry is not loaded for the chat extension")})).catch((e=>{console.error(`Something went wrong when reading the settings.\n${e}`)}));let m=null;try{m=(0,i.buildChatSidebar)({model:l,themeManager:n,rmRegistry:r}),m.title.caption="Codestral Chat"}catch(e){m=(0,i.buildErrorWidget)(n)}e.shell.add(m,"left",{rank:2e3}),console.log("Chat extension initialized")}},f={id:"@jupyterlite/ai:ai-provider",autoStart:!0,requires:[o.ICompletionProviderManager,l.ISettingRegistry],provides:y,activate:(e,t,r)=>{const i=new v({completionProviderManager:t,requestCompletion:()=>e.commands.execute("inline-completer:invoke")});return r.load(f.id).then((e=>{const t=()=>{const t=e.get("provider").composite;i.setModels(t,e.composite)};e.changed.connect((()=>t())),t()})).catch((e=>{console.error(`Failed to load settings for ${f.id}`,e)})),i}},M=[C,f]}}]);