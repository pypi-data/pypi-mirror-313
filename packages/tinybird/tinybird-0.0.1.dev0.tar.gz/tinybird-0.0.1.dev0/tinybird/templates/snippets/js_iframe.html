
function insertCodePen(container, js_code) {
  var code = "async function run() {\n" + js_code + "\n}\nrun();"
  var f = document.createElement("form");
  f.setAttribute('method',"post");
  f.setAttribute('action',"https://codepen.io/pen/define")
  f.setAttribute('target', "_blank")

  var i = document.createElement("input");
  i.setAttribute('type',"hidden");
  i.setAttribute('name',"data");
  i.setAttribute('value',JSON.stringify({
    "title": "Tinybird Pen!", 
    "html": "Open the console below!", 
    "js": code,
    "js_external": "https://cdn.tinybird.co/static/js/tinybird.js"
  }))

  var b = document.createElement('button');
  var ba = document.createElement('span')
  b.setAttribute('type','submit');
  b.innerHTML = '<svg width="16" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><path d="M255.807 87.087c-.059-.31-.11-.62-.193-.924-.052-.183-.114-.355-.172-.535a11.007 11.007 0 00-.283-.8c-.076-.182-.162-.358-.245-.534a9.74 9.74 0 00-.376-.73c-.096-.176-.207-.342-.313-.51a11.038 11.038 0 00-.842-1.142 11.166 11.166 0 00-.544-.596c-.145-.145-.29-.29-.442-.431a9.07 9.07 0 00-.624-.52c-.165-.128-.327-.26-.5-.377-.061-.044-.117-.096-.182-.138L134.099 1.85a10.989 10.989 0 00-12.201 0l-117 77.998c-.065.041-.116.093-.182.138-.172.12-.334.248-.5.376a15.52 15.52 0 00-.624.517 8.604 8.604 0 00-.438.43c-.193.194-.372.39-.548.597-.13.155-.255.31-.376.483-.165.217-.317.438-.465.669-.107.169-.214.334-.314.51a9.593 9.593 0 00-.372.724c-.083.176-.172.355-.245.534-.107.262-.2.531-.286.8-.058.18-.12.355-.169.517-.08.303-.138.61-.193.924-.03.159-.069.314-.09.476-.062.475-.096.951-.096 1.437v78.016c0 .482.034.965.103 1.437.025.173.07.31.104.476.055.31.103.62.207.931.048.172.103.345.172.534.086.276.172.552.276.804.072.172.172.344.241.517.114.241.242.482.38.734.096.172.206.345.31.503.148.242.31.449.482.655.121.173.242.31.38.476.175.207.344.414.551.597.141.137.276.31.448.413.2.173.414.345.62.524.166.138.346.242.483.376.066.034.104.103.173.134l116.968 78.04a10.815 10.815 0 006.102 1.851 11.06 11.06 0 006.102-1.85l117-78c.065-.04.12-.089.182-.134.172-.12.334-.248.5-.375.214-.17.424-.345.624-.524.151-.135.296-.283.441-.428a9.876 9.876 0 00.92-1.072c.166-.217.318-.441.466-.669.107-.165.214-.334.314-.503.138-.242.258-.486.375-.734.083-.176.17-.352.245-.531.107-.266.197-.535.283-.804.058-.179.12-.355.172-.534.08-.303.135-.614.193-.924.028-.159.07-.314.086-.476.063-.475.097-.951.097-1.437V89c0-.486-.038-.962-.097-1.438-.027-.169-.079-.306-.113-.475h.017zm-127.81 66.935l-38.905-26.021 38.905-26.025 38.907 26.025-38.907 26.021zm-10.998-71.155l-47.692 31.9L30.81 89.013 117 31.555v51.312zm-67.477 45.13l-27.517 18.406v-36.811l27.517 18.405zm19.785 13.245L117 173.138v51.312l-86.19-57.465 38.498-25.75v.007zm69.69 31.89l47.692-31.896 38.501 25.749-86.193 57.458v-51.312zm67.477-45.128l27.521-18.409v36.815l-27.52-18.413v.007zm-19.785-13.238L138.997 82.87V31.555l86.193 57.459-38.5 25.752z" fill="#1FCC83"/></svg>'
  b.className = 'codepen-button tooltip'
  ba.className = 'tooltiptext'
  ba.innerText = 'Open in Codepen'
  b.appendChild(ba)

  f.appendChild(i);
  f.appendChild(b);

  container.appendChild(f)
}

function insertCopyButton(container, code) {
  var b = document.createElement('button')
  var ba = document.createElement('span')
  b.innerHTML = '<svg width="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><g opacity="1"><mask id="16039697671470.10957705614956215" fill="white"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 3H7V9H13V3ZM7 2C6.44772 2 6 2.44772 6 3V9C6 9.55228 6.44772 10 7 10H13C13.5523 10 14 9.55228 14 9V3C14 2.44772 13.5523 2 13 2H7Z"></path></mask><path mask="url(#16039697671470.10957705614956215)" fill="#1FCC83" d="M7 3V2H6V3H7ZM13 3H14V2H13V3ZM7 9H6V10H7V9ZM13 9V10H14V9H13ZM7 4H13V2H7V4ZM8 9V3H6V9H8ZM13 8H7V10H13V8ZM12 3V9H14V3H12ZM7 3V1C5.89543 1 5 1.89543 5 3H7ZM7 9V3H5V9H7ZM7 9H5C5 10.1046 5.89543 11 7 11V9ZM13 9H7V11H13V9ZM13 9V11C14.1046 11 15 10.1046 15 9H13ZM13 3V9H15V3H13ZM13 3H15C15 1.89543 14.1046 1 13 1V3ZM7 3H13V1H7V3Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M6 7H3V13H9V10H10V13C10 13.5523 9.55228 14 9 14H3C2.44772 14 2 13.5523 2 13V7C2 6.44772 2.44772 6 3 6H6V7Z" fill="#1FCC83"></path></g></svg>'
  b.className = 'copy-button tooltip'
  ba.className = 'tooltiptext'
  ba.innerText = 'Copy'
  b.appendChild(ba)
  code = code
  b.onclick = function() {
    var dummy = document.createElement("textarea");
    document.body.appendChild(dummy);
    dummy.innerHTML = code;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
  }

  container.appendChild(b)
}

function escapeSpecialChars(s) {
  return s.replace(/[\\]/g, '\\\\')
    .replace(/[\"]/g, '\\\"')
    .replace(/[\/]/g, '\\/')
    .replace(/[\b]/g, '\\b')
    .replace(/[\f]/g, '\\f')
    .replace(/[\n]/g, '\\n')
    .replace(/[\r]/g, '\\r')
    .replace(/[\t]/g, '\\t');
};

async function run_{{ id }}(){
  var error = false;
  var el_code = document.getElementById('{{ id }}_code')

  // replace <pipe> and <token>
  el_code.innerHTML = el_code.innerHTML
    .replace(new RegExp('&lt;pipe&gt;', 'g'), '{{pipe}}')
    .replace('&lt;token&gt;', '{{jwt_read}}')
    .replace('&lt;import_token&gt;', '{{jwt_import}}')
    .replace('&lt;column&gt;', '{{column}}')

  // Caption text div
  var caption = el_code.parentElement.getElementsByTagName('div')[0].getElementsByClassName('caption-text')[0]
  var headerlink = el_code.parentElement.getElementsByTagName('div')[0].getElementsByClassName('headerlink')[0]
  var captionDiv = document.createElement('div')
  el_code.parentElement.getElementsByTagName('div')[0].classList.add('flex-between-center')
  el_code.parentElement.getElementsByTagName('div')[0].appendChild(captionDiv)
  captionDiv.appendChild(caption)
  captionDiv.appendChild(headerlink)

  // Add actions wrapper div
  var codeActionsDiv = document.createElement('div')
  codeActionsDiv.className = 'code-actions' 
  var parentElement = el_code.parentElement.getElementsByTagName('div')[0]
  parentElement.appendChild(codeActionsDiv)

  insertCopyButton(codeActionsDiv, {% raw js_json_escaped %})
 }
 run_{{ id }}();
